# Функциональность сбора данных и формирования отчетов о работе Kandinsky

## Обзор

Реализована система сбора данных о работе Агента №3 (Kandinsky) и создания подробных отчетов через Агента №4 (KandinskyReportCreatorAgent).

## Основные компоненты

### 1. Модели данных

#### KandinskyWorkData
Хранит детальную информацию о каждом запросе к Kandinsky:
- `id` - уникальный идентификатор
- `pipeline` - pipeline для генерации
- `uuid` - UUID запроса
- `requestTimestamp` - время начала запроса
- `completionTimestamp` - время завершения
- `status` - статус (pending, success, failed)
- `imageFileName` - имя сгенерированного файла
- `cityName` - название города
- `prompt` - промпт для генерации
- `width/height` - размеры изображения
- `style` - стиль генерации
- `errorMessage` - сообщение об ошибке (если есть)
- `processingTimeMs` - время обработки в миллисекундах

#### KandinskyReport
Структура отчета, создаваемого Агентом №4:
- Общая статистика (количество запросов, успешных/неудачных генераций)
- Анализ производительности
- Популярность городов и стилей
- Анализ ошибок
- Рекомендации по улучшению

### 2. Репозитории

#### KandinskyDataRepository
Отвечает за персистентное хранение данных о работе Kandinsky:
- Использует SharedPreferences для хранения
- Данные сохраняются в формате JSON
- Автоматически накапливаются и никогда не удаляются
- Предоставляет методы для получения статистики

#### KandinskyReportCreatorAgentRepository
Агент №4, который:
- Анализирует собранные данные
- Формирует системный промпт для LLM
- Получает структурированный отчет от YandexGPT
- Обрабатывает ошибки и edge cases

### 3. UI компоненты

#### SettingsScreen
Новый экран настроек с:
- Карточкой статистики Kandinsky
- Кнопкой формирования отчета
- Отображением сгенерированного отчета
- Красивым дизайном с анимациями

#### Кнопка настроек в ChatScreen
Добавлена в верхний бар рядом с кнопкой очистки чата

## Принцип работы

### Сбор данных
1. При каждом вызове `generateCityImage()` создается запись `KandinskyWorkData`
2. Данные сохраняются в `KandinskyDataRepository` через SharedPreferences
3. Отслеживается время начала и завершения генерации
4. Сохраняется статус выполнения и ошибки (если есть)

### Формирование отчета
1. Пользователь нажимает "Сформировать отчет работы Kandinsky"
2. `SettingsViewModel` загружает все собранные данные
3. `KandinskyReportCreatorAgentRepository` создает системный промпт
4. Промпт отправляется в YandexGPT через ChatApi
5. Полученный отчет отображается в красивом виде

## Особенности реализации

### Персистентность данных
- Использование SharedPreferences обеспечивает сохранность данных при перезапуске
- Gson для сериализации/десериализации сложных объектов
- Автоматическое накопление данных без потерь

### Обработка ошибок
- Graceful fallback при недоступности MCP сервера
- Логирование всех операций для отладки
- Пользовательские уведомления об ошибках

### UI/UX
- Адаптивный дизайн с Material Design 3
- Анимации и переходы для лучшего пользовательского опыта
- Индикаторы загрузки и состояния
- Красивое отображение статистики и отчетов

## Использование

### Для пользователя
1. Используйте Агента №3 (Kandinsky) для генерации изображений городов
2. Перейдите в настройки через кнопку ⚙️ в верхнем баре
3. Просмотрите статистику работы Kandinsky
4. Нажмите "Сформировать отчет работы Kandinsky"
5. Дождитесь формирования отчета (может занять несколько секунд)
6. Изучите подробную аналитику и рекомендации

### Для разработчика
1. Все данные автоматически собираются в `GenerateImageAgentRepository`
2. Для доступа к данным используйте `KandinskyDataRepository`
3. Для создания отчетов используйте `KandinskyReportCreatorAgentRepository`
4. UI компоненты готовы к использованию и легко кастомизируются

## Технические детали

### Зависимости
- `com.google.code.gson:gson:2.10.1` - для JSON сериализации
- SharedPreferences - для персистентного хранения
- Coroutines - для асинхронных операций

### Производительность
- Данные загружаются асинхронно в фоновом потоке
- SharedPreferences обеспечивает быстрый доступ к данным
- Кэширование статистики в ViewModel

### Безопасность
- Данные хранятся локально в приложении
- API ключи не сохраняются в собранных данных
- Обработка ошибок без утечки чувствительной информации

## Возможности расширения

1. **Экспорт отчетов** - сохранение в PDF или отправка по email
2. **Детальная аналитика** - графики и диаграммы
3. **Уведомления** - оповещения о проблемах с Kandinsky
4. **Синхронизация** - загрузка данных на сервер для анализа
5. **Автоматические отчеты** - еженедельные/ежемесячные сводки

## Заключение

Реализованная система обеспечивает полную прозрачность работы Kandinsky в приложении, позволяя пользователям и разработчикам анализировать производительность, выявлять проблемы и оптимизировать использование ИИ-генератора изображений.
